<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRS Flashcard Cloud Sync</title>
    <!-- Caricamento di Tailwind CSS per uno styling rapido e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Caricamento di Marked.js per il rendering del Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Stili Personalizzati */
        :root {
            --primary-color: #3b82f6;
            --success-color: #10b981;
            --danger-color: #ef4444;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card-content {
            min-height: 150px;
            text-align: left;
            padding: 1.5rem;
            background: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        /* Stile per il contenuto Markdown */
        .card-content h1, .card-content h2 { font-size: 1.5em; margin-bottom: 0.5em; font-weight: 700; }
        .card-content p { margin-bottom: 1em; line-height: 1.6; }
        .card-content img { max-width: 100%; height: auto; border-radius: 0.5rem; margin: 1em 0; }
        .card-content ul { list-style: disc; margin-left: 1.5em; padding-left: 0; }
        .card-content strong { font-weight: 600; }
        /* Stile specifico per l'archivio carte */
        .card-list-item:hover {
            background-color: #f3f4f6;
            transform: scale(1.01);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Contenitore Principale -->
    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">SRS Cloud Flashcard Manager</h1>
        
        <!-- User ID Display (Importante per il Debug Firestore) -->
        <p id="user-info" class="text-xs text-center text-gray-500 mb-4">Utente: In attesa di autenticazione...</p>

        <!-- Navigazione (Menu) -->
        <nav class="flex justify-center space-x-4 mb-8">
            <button onclick="showView('review')" id="nav-review" class="px-4 py-2 text-sm font-medium rounded-lg transition duration-150 hover:bg-blue-100 bg-blue-500 text-white">Ripasso Giornaliero</button>
            <button onclick="showView('create')" id="nav-create" class="px-4 py-2 text-sm font-medium rounded-lg transition duration-150 hover:bg-gray-200 text-gray-700">Crea Nuova Carta</button>
            <button onclick="showView('archive')" id="nav-archive" class="px-4 py-2 text-sm font-medium rounded-lg transition duration-150 hover:bg-gray-200 text-gray-700">Gestione Archivio</button>
            <button onclick="showView('stats')" id="nav-stats" class="px-4 py-2 text-sm font-medium rounded-lg transition duration-150 hover:bg-gray-200 text-gray-700">Riepilogo & Statistiche</button>
            <button onclick="showView('auth')" id="nav-auth" class="px-4 py-2 text-sm font-medium rounded-lg transition duration-150 hover:bg-yellow-100 text-yellow-700">Login/Logout</button>
        </nav>

        <!-- Area Contenuto Dinamico -->
        <div id="app-content">
        </div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, EmailAuthProvider, linkWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"; 
        
        // Attiva il logging per facilitare il debug
        setLogLevel('Debug');
        
        // --- INCOLLA QUI LA TUA CONFIGURAZIONE FIREBASE (da Passo 1.2) ---
        // Se non la incolli, l'app NON funzioner√† con la sincronizzazione cloud.
      const FIREBASE_CONFIG = {
        apiKey: "AIzaSyDN072WovJqyKE2Sw16PeSz1z9-50G8f9c",
        authDomain: "flashcard-9d034.firebaseapp.com",
        projectId: "flashcard-9d034",
        storageBucket: "flashcard-9d034.firebasestorage.app",
        messagingSenderId: "779697153912",
        appId: "1:779697153912:web:163d564cd9dba40d338a8d",
        measurementId: "G-6LWH9W8YEL"
      };

        const appId = FIREBASE_CONFIG.projectId;
        const firebaseConfig = FIREBASE_CONFIG;
        const initialAuthToken = null;

        // Inizializzazione Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Inizializzazione Analytics per evitare l'errore se la config la include
        const analytics = getAnalytics(app); 


        // Espone le funzioni e variabili necessarie
        window.firebaseApp = { 
            db, auth, 
            onSnapshot, getDoc, 
            EmailAuthProvider, linkWithCredential, 
            createUserWithEmailAndPassword, signInWithEmailAndPassword,
            collection, doc, query, setDoc, deleteDoc, // Aggiunto deleteDoc
            onAuthStateChanged, 
            signInWithCustomToken
        };
    </script>

    <!-- Script JavaScript Principale -->
    <script>
        // CONFIGURAZIONE GLOBALE E MODELLO DATI
        const STORE_NAME = 'flashcards';
        const STATS_DOC_ID = 'global_stats';
        
        // A. Dati Globali (Constants)
        const INTERVALS = [1, 3, 7, 16, 35];

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let isAnonymous = false; 

        let allCards = [];
        let dueCards = [];
        let currentCardIndex = 0;
        let currentView = 'review';
        let stats = { totalOk: 0, totalKo: 0, totalCards: 0, topicStats: {} };

        // --- UTILITY PER DATE E LOGICA SRS ---

        function getMidnightTimestamp(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            return d.getTime();
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function calculateNextReview(card, isCorrect) {
            let newLevel = card.livelloDiRipetizione;

            if (isCorrect) {
                newLevel = Math.min(newLevel + 1, INTERVALS.length);
            } else {
                newLevel = Math.max(1, newLevel - 1);
            }

            const daysToWait = INTERVALS[newLevel - 1];
            const today = new Date();
            const nextReviewDate = getMidnightTimestamp(addDays(today, daysToWait));

            return {
                livelloDiRipetizione: newLevel,
                dataDiProssimoRipasso: nextReviewDate
            };
        }

        // --- LOGICA FIREBASE FIRESTORE ---

        function getCardsCollectionRef(database, currentUserId) {
            const appId = firebaseApp.FIREBASE_CONFIG ? firebaseApp.FIREBASE_CONFIG.projectId : 'default-app-id';
            return firebaseApp.collection(database, 'artifacts', appId, 'users', currentUserId, STORE_NAME);
        }

        function getStatsDocRef(database, currentUserId) {
            const appId = firebaseApp.FIREBASE_CONFIG ? firebaseApp.FIREBASE_CONFIG.projectId : 'default-app-id';
            return firebaseApp.doc(database, 'artifacts', appId, 'users', currentUserId, 'stats', STATS_DOC_ID);
        }
        
        async function saveCard(card) {
            if (!userId) {
                console.error("Tentativo di salvare la carta senza userId. Dati non salvati.");
                return;
            }
            try {
                // setDoc crea o aggiorna una carta esistente in base all'ID
                await firebaseApp.setDoc(firebaseApp.doc(getCardsCollectionRef(db, userId), String(card.id)), card);
            } catch (error) {
                console.error("Errore nel salvataggio della carta in Firestore:", error);
                throw error;
            }
        }

        async function deleteCard(cardId) {
            if (!userId) {
                console.error("Tentativo di eliminare la carta senza userId.");
                return;
            }
            try {
                await firebaseApp.deleteDoc(firebaseApp.doc(getCardsCollectionRef(db, userId), String(cardId)));
                alertMessage(`Carta eliminata con successo!`, 'success');
            } catch (error) {
                console.error("Errore nell'eliminazione della carta in Firestore:", error);
                alertMessage(`Errore nell'eliminazione della carta.`, 'danger');
                throw error;
            }
        }


        async function saveStats() {
            if (!userId) return;
            try {
                await firebaseApp.setDoc(getStatsDocRef(db, userId), stats, { merge: true });
            } catch (error) {
                console.error("Errore nel salvataggio delle statistiche in Firestore:", error);
                throw error;
            }
        }
        
        async function loadStats() {
            if (!userId) return;
            try {
                const docSnap = await firebaseApp.getDoc(getStatsDocRef(db, userId));
                if (docSnap.exists()) {
                    stats = { ...stats, ...docSnap.data() };
                }
                stats.totalCards = allCards.length;
            } catch (error) {
                console.warn("Impossibile caricare le statistiche in Firestore.");
            }
        }

        let unsubscribeCards = null;

        /**
         * setupCardListener mantiene allCards aggiornato in tempo reale.
         * allCards contiene SEMPRE TUTTE le carte.
         */
        function setupCardListener() {
            if (unsubscribeCards) {
                unsubscribeCards(); 
            }
            if (!userId || !isAuthReady) return;

            const cardsQuery = firebaseApp.query(getCardsCollectionRef(db, userId));

            unsubscribeCards = firebaseApp.onSnapshot(cardsQuery, (snapshot) => {
                allCards = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.dataDiProssimoRipasso = data.dataDiProssimoRipasso || 0; 
                    allCards.push(data);
                });

                const today = getMidnightTimestamp(new Date());

                // dueCards contiene solo le carte per la vista di ripasso
                dueCards = allCards
                    .filter(card => card.dataDiProssimoRipasso <= today)
                    .sort((a, b) => a.dataDiProssimoRipasso - b.dataDiProssimoRipasso);

                stats.totalCards = allCards.length;

                // Aggiorna solo la vista se non siamo nel mezzo di una modifica
                if (currentView !== 'edit' && (currentView === 'review' || currentView === 'stats' || currentView === 'archive')) {
                    showView(currentView);
                }
                console.log(`[Firestore] Carte caricate/aggiornate: ${allCards.length}, Dovute oggi: ${dueCards.length}`);

            }, (error) => {
                console.error("Errore onSnapshot:", error);
                alertMessage("Errore di sincronizzazione dati: controllare la console.", 'danger');
            });
        }

        // --- GESTIONE VISTE E FLUSSO APPLICAZIONE ---

        function showView(viewName) {
            currentView = viewName;
            const contentDiv = document.getElementById('app-content');
            
            document.querySelectorAll('nav button').forEach(btn => {
                const isSelected = btn.id === `nav-${viewName}`;
                btn.classList.toggle('bg-blue-500', isSelected);
                btn.classList.toggle('text-white', isSelected);
                btn.classList.toggle('hover:bg-blue-600', isSelected);
                btn.classList.toggle('bg-gray-200', !isSelected && btn.id !== 'nav-auth');
                btn.classList.toggle('text-gray-700', !isSelected && btn.id !== 'nav-auth');
                
                // Stile speciale per il pulsante Auth
                if (btn.id === 'nav-auth') {
                    btn.classList.toggle('bg-yellow-400', isSelected);
                    btn.classList.toggle('text-gray-800', isSelected);
                    btn.classList.toggle('hover:bg-yellow-500', isSelected);
                    btn.classList.toggle('text-yellow-700', !isSelected);
                    btn.classList.toggle('hover:bg-yellow-100', !isSelected);
                }
            });

            if (!isAuthReady || userId === null) {
                // Se non √® autenticato, forza la visualizzazione della schermata di autenticazione
                if (viewName !== 'auth') {
                     return showView('auth');
                }
            }

            contentDiv.innerHTML = '<div class="flex justify-center items-center h-48"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div></div>';

            switch (viewName) {
                case 'review':
                    renderReviewView();
                    break;
                case 'create':
                    renderCreateView();
                    break;
                case 'archive':
                    renderArchiveView(); // NUOVA VISTA
                    break;
                case 'stats':
                    loadStats().then(renderStatsView);
                    break;
                case 'auth':
                    renderAuthView();
                    break;
                default:
                    renderReviewView();
            }
        }
        
        // A. Schermata di Ripasso Giornaliero - (Nessuna modifica alla logica di rendering)

        let isAnswerVisible = false;

        function renderReviewView() {
            // ... (funzione renderReviewView rimane invariata) ...
            const contentDiv = document.getElementById('app-content');
            
            if (dueCards.length === 0) {
                contentDiv.innerHTML = `
                    <div class="text-center p-8 bg-green-50 rounded-lg border border-green-200">
                        <svg class="mx-auto h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h2 class="text-xl font-semibold text-green-800 mt-3">Complimenti!</h2>
                        <p class="text-green-700 mt-1">Non hai carte da ripassare per oggi. Torna domani!</p>
                        <p class="text-sm text-green-600 mt-4">Totale carte in archivio: ${allCards.length}</p>
                    </div>
                `;
                return;
            }

            const card = dueCards[currentCardIndex];
            isAnswerVisible = false;

            const nextCardButtonHtml = (currentCardIndex < dueCards.length - 1) ? 
                `<p class="text-sm text-gray-500 mt-4">Prossima carta: ${currentCardIndex + 2} di ${dueCards.length}</p>` :
                `<p class="text-sm text-gray-500 mt-4">Questa √® l'ultima carta del giorno!</p>`;

            contentDiv.innerHTML = `
                <div class="text-center mb-6">
                    <p class="text-lg font-medium text-gray-600">Carta ${currentCardIndex + 1} di ${dueCards.length} in ripasso.</p>
                    <p class="text-sm text-gray-400">Argomento: <span class="font-semibold text-gray-600">${card.argomento}</span></p>
                </div>

                <div class="bg-white rounded-xl shadow-lg border-2 border-blue-400 p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h2 class="text-2xl font-bold text-blue-700">Domanda:</h2>
                        <span class="px-3 py-1 bg-blue-100 text-blue-600 text-xs font-semibold rounded-full">Livello ${card.livelloDiRipetizione}</span>
                    </div>
                    
                    <div id="card-question-content" class="card-content">
                        ${marked.parse(card.domanda)}
                    </div>
                    
                    <button id="show-answer-btn" onclick="showAnswer()" class="w-full mt-6 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-150">
                        Mostra Risposta
                    </button>
                    
                    <div id="card-answer-container" class="mt-6 border-t pt-6 hidden">
                        <h2 class="text-2xl font-bold text-green-700 mb-4">Risposta:</h2>
                        <div id="card-answer-content" class="card-content border-green-200">
                        </div>

                        <div class="flex justify-center space-x-4 mt-8">
                            <button onclick="handleReview(false)" class="flex items-center px-6 py-3 bg-red-500 text-white font-bold rounded-xl shadow-lg hover:bg-red-600 transition duration-150 transform hover:scale-105">
                                <span class="text-xl mr-2">‚ùå</span> KO (Sbagliata)
                            </button>
                            <button onclick="handleReview(true)" class="flex items-center px-6 py-3 bg-green-500 text-white font-bold rounded-xl shadow-lg hover:bg-green-600 transition duration-150 transform hover:scale-105">
                                <span class="text-xl mr-2">üëç</span> OK (Corretta)
                            </button>
                        </div>
                    </div>
                </div>
                ${nextCardButtonHtml}
            `;
        }

        // --- B. Schermata di Creazione/Modifica Carte ---
        
        function renderCreateView(cardToEdit = null) {
            const contentDiv = document.getElementById('app-content');
            const isEditing = cardToEdit !== null;
            const cardId = isEditing ? cardToEdit.id : '';
            const cardDataDiProssimoRipasso = isEditing ? cardToEdit.dataDiProssimoRipasso : '';
            const cardLivelloDiRipetizione = isEditing ? cardToEdit.livelloDiRipetizione : '';

            contentDiv.innerHTML = `
                <div class="max-w-xl mx-auto p-6 bg-gray-50 rounded-xl shadow-inner">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">${isEditing ? 'Modifica Carta' : 'Nuova Flashcard'}</h2>
                    
                    <!-- Campi nascosti per il salvataggio in caso di modifica -->
                    <input type="hidden" id="card-id" value="${cardId}">
                    <input type="hidden" id="card-next-review" value="${cardDataDiProssimoRipasso}">
                    <input type="hidden" id="card-level" value="${cardLivelloDiRipetizione}">

                    <form id="create-card-form" onsubmit="event.preventDefault(); handleSaveCard(event, ${isEditing});">
                        
                        <div class="mb-4">
                            <label for="argomento" class="block text-sm font-medium text-gray-700 mb-1">Argomento (Categorizzazione)</label>
                            <input type="text" id="argomento" name="argomento" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" value="${isEditing ? cardToEdit.argomento : ''}">
                        </div>

                        <div class="mb-4">
                            <label for="domanda" class="block text-sm font-medium text-gray-700 mb-1">Domanda (Markdown supportato)</label>
                            <textarea id="domanda" name="domanda" rows="4" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">${isEditing ? cardToEdit.domanda : ''}</textarea>
                            <button type="button" onclick="previewMarkdown('domanda', 'preview-domanda')" class="mt-1 text-xs text-blue-600 hover:text-blue-800">Anteprima Domanda</button>
                            <div id="preview-domanda" class="mt-2 p-3 bg-white border border-dashed border-gray-300 rounded-lg hidden card-content"></div>
                        </div>

                        <div class="mb-6">
                            <label for="risposta" class="block text-sm font-medium text-gray-700 mb-1">Risposta (Markdown supportato)</label>
                            <textarea id="risposta" name="risposta" rows="6" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">${isEditing ? cardToEdit.risposta : ''}</textarea>
                            <button type="button" onclick="previewMarkdown('risposta', 'preview-risposta')" class="mt-1 text-xs text-blue-600 hover:text-blue-800">Anteprima Risposta</button>
                            <div id="preview-risposta" class="mt-2 p-3 bg-white border border-dashed border-gray-300 rounded-lg hidden card-content"></div>
                        </div>
                        
                        <button type="submit" class="w-full py-3 bg-green-500 text-white font-bold rounded-xl shadow-lg hover:bg-green-600 transition duration-150">
                            ${isEditing ? 'Aggiorna Carta' : 'Salva Nuova Carta'}
                        </button>
                    </form>

                    ${isEditing ? `<button onclick="handleDeleteCard(${cardId})" class="mt-4 w-full py-2 bg-red-500 text-white font-bold rounded-xl shadow-lg hover:bg-red-600 transition duration-150">Elimina Carta</button>` : ''}


                    <div id="message-container" class="mt-4"></div>
                </div>
            `;
            // Esegue l'anteprima iniziale se sta modificando
            if (isEditing) {
                previewMarkdown('domanda', 'preview-domanda');
                previewMarkdown('risposta', 'preview-risposta');
            }
        }
        
        /** Wrapper per la creazione (dal menu principale) */
        function handleCreateCard() {
             renderCreateView(null);
        }

        /** Gestisce il salvataggio o l'aggiornamento della carta */
        async function handleSaveCard(event, isEditing) {
            const form = event.target;
            const data = new FormData(form);

            const today = new Date();
            let nextReviewDate;
            let currentLevel;
            let cardId;

            if (isEditing) {
                // Mantiene il livello e la data di ripasso esistenti
                cardId = document.getElementById('card-id').value;
                currentLevel = parseInt(document.getElementById('card-level').value);
                nextReviewDate = parseInt(document.getElementById('card-next-review').value);
            } else {
                // Nuova carta: Livello 1, ripasso domani
                cardId = Date.now();
                currentLevel = 1;
                nextReviewDate = getMidnightTimestamp(addDays(today, INTERVALS[0]));
            }


            const cardData = {
                id: Number(cardId), // L'ID deve essere un numero per evitare problemi di ordinamento
                domanda: data.get('domanda').trim(),
                risposta: data.get('risposta').trim(),
                argomento: data.get('argomento').trim() || 'Generale',
                livelloDiRipetizione: currentLevel,
                dataDiProssimoRipasso: nextReviewDate
            };

            try {
                await saveCard(cardData);
                if (!isEditing) {
                    form.reset();
                    const previewDomanda = document.getElementById('preview-domanda');
                    const previewRisposta = document.getElementById('preview-risposta');
                    if (previewDomanda) previewDomanda.classList.add('hidden');
                    if (previewRisposta) previewRisposta.classList.add('hidden');
                }

                alertMessage(`Carta ${isEditing ? 'aggiornata' : 'creata'} con successo!`, 'success');
                // Torna all'archivio dopo la modifica
                if (isEditing) {
                    showView('archive');
                }
            } catch (e) {
                console.error("Errore nel salvataggio della carta:", e);
                alertMessage(`Errore: impossibile ${isEditing ? 'aggiornare' : 'salvare'} la carta nel database cloud.`, 'danger');
            }
        }

        // --- C. Gestione Archivio Carte (NUOVA VISTA) ---

        function renderArchiveView() {
            const contentDiv = document.getElementById('app-content');

            if (allCards.length === 0) {
                contentDiv.innerHTML = `
                    <div class="text-center p-8 bg-blue-50 rounded-lg border border-blue-200">
                        <h2 class="text-xl font-semibold text-blue-800 mt-3">Archivio Vuoto</h2>
                        <p class="text-blue-700 mt-1">Non hai ancora inserito nessuna flashcard. Vai alla schermata "Crea Nuova Carta" per iniziare!</p>
                    </div>
                `;
                return;
            }

            // Ordina le carte per argomento e poi per livello di ripasso
            const sortedCards = allCards.sort((a, b) => {
                if (a.argomento < b.argomento) return -1;
                if (a.argomento > b.argomento) return 1;
                return a.livelloDiRipetizione - b.livelloDiRipetizione;
            });

            let listHtml = '';
            sortedCards.forEach(card => {
                const nextReviewDate = new Date(card.dataDiProssimoRipasso).toLocaleDateString('it-IT');
                const firstLine = marked.parseInline(card.domanda).replace(/<\/?[^>]+(>|$)/g, "").substring(0, 80) + '...';

                listHtml += `
                    <div class="card-list-item p-4 mb-2 bg-white rounded-lg shadow cursor-pointer transition duration-150 ease-in-out border border-gray-100" onclick="editCard(${card.id})">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm font-semibold text-gray-800">${firstLine}</p>
                                <p class="text-xs text-gray-500">Argomento: ${card.argomento}</p>
                            </div>
                            <div class="text-right flex flex-col items-end">
                                <span class="px-3 py-0.5 text-xs font-medium rounded-full bg-blue-100 text-blue-700">Livello ${card.livelloDiRipetizione}</span>
                                <span class="text-xs text-gray-400 mt-1">Ripasso: ${nextReviewDate}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            contentDiv.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Archivio Completo (${allCards.length} Carte)</h2>
                <div class="space-y-3 max-h-[60vh] overflow-y-auto">
                    ${listHtml}
                </div>
                <div id="message-container" class="mt-4"></div>
            `;
        }

        /** Funzione per trovare e passare la carta alla vista di modifica */
        function editCard(cardId) {
            const card = allCards.find(c => c.id === cardId);
            if (card) {
                // Passa l'oggetto carta alla funzione di rendering che ora gestisce sia Crea che Modifica
                renderCreateView(card); 
                currentView = 'edit'; // Imposta la vista su "edit" per prevenire re-render indesiderati
            } else {
                alertMessage("Carta non trovata nell'archivio.", 'danger');
            }
        }
        
        /** Gestisce l'eliminazione di una carta */
        function handleDeleteCard(cardId) {
            const cardToDelete = allCards.find(c => c.id === cardId);
            if (!cardToDelete) return;

            if (confirm(`Sei sicuro di voler eliminare la carta: ${marked.parseInline(cardToDelete.domanda).substring(0, 30)}...?`)) {
                deleteCard(cardId).then(() => {
                    // onSnapshot aggiorner√† automaticamente l'archivio, ma torniamo subito per feedback
                    showView('archive'); 
                });
            }
        }

        function previewMarkdown(inputId, previewId) {
            const input = document.getElementById(inputId).value;
            const preview = document.getElementById(previewId);
            
            if (input.trim() === '') {
                preview.classList.add('hidden');
                return;
            }
            
            preview.innerHTML = marked.parse(input); 
            preview.classList.remove('hidden');
        }

        function renderStatsView() {
            // ... (funzione renderStatsView rimane invariata) ...
            const contentDiv = document.getElementById('app-content');
            const totalAttempts = stats.totalOk + stats.totalKo;
            const successRate = totalAttempts > 0 ? ((stats.totalOk / totalAttempts) * 100).toFixed(1) : '0.0';
            const dueToday = dueCards.length;
            
            let topicRows = '';
            for (const [topic, topicStats] of Object.entries(stats.topicStats)) {
                const topicAttempts = topicStats.ok + topicStats.ko;
                const topicRate = topicAttempts > 0 ? ((topicStats.ok / topicAttempts) * 100).toFixed(1) : '0.0';
                
                topicRows += `
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${topic}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${topicStats.ok}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${topicStats.ko}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-bold ${parseFloat(topicRate) > 70 ? 'text-green-600' : 'text-orange-600'}">${topicRate}%</td>
                    </tr>
                `;
            }

            contentDiv.innerHTML = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Riepilogo e Statistiche Globali</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-blue-50 p-6 rounded-xl shadow-md border-b-4 border-blue-500 text-center">
                            <p class="text-5xl font-extrabold text-blue-700">${stats.totalCards}</p>
                            <p class="text-gray-600 mt-2">Totale Carte Archiviate</p>
                        </div>
                        
                        <div class="bg-red-50 p-6 rounded-xl shadow-md border-b-4 border-red-500 text-center">
                            <p class="text-5xl font-extrabold text-red-700">${dueToday}</p>
                            <p class="text-gray-600 mt-2">Carte da Ripassare Oggi</p>
                        </div>
                        
                        <div class="bg-green-50 p-6 rounded-xl shadow-md border-b-4 border-green-500 text-center">
                            <p class="text-5xl font-extrabold text-green-700">${successRate}%</p>
                            <p class="text-gray-600 mt-2">Percentuale di Successo (OK)</p>
                        </div>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-800 mb-4 mt-8">Metriche per Argomento</h3>
                    <div class="overflow-x-auto shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-300">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Argomento</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Totale OK</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Totale KO</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tasso di Successo</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 bg-white">
                                ${topicRows || '<tr><td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">Nessuna statistica disponibile per argomento.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                    
                    <p class="text-sm text-gray-500 mt-6 text-center">Ultimo aggiornamento: ${new Date().toLocaleDateString('it-IT')}</p>
                </div>
            `;
        }

        function alertMessage(message, type) {
            // ... (funzione alertMessage rimane invariata) ...
            const container = document.getElementById('message-container') || document.getElementById('app-content');
            let bgColor, borderColor, textColor;

            switch(type) {
                case 'success':
                    bgColor = 'bg-green-100';
                    borderColor = 'border-green-400';
                    textColor = 'text-green-700';
                    break;
                case 'danger':
                    bgColor = 'bg-red-100';
                    borderColor = 'border-red-400';
                    textColor = 'text-red-700';
                    break;
                default:
                    bgColor = 'bg-blue-100';
                    borderColor = 'border-blue-400';
                    textColor = 'text-blue-700';
            }

            const alertHtml = `
                <div id="temp-alert" class="${bgColor} ${borderColor} ${textColor} border-l-4 p-4 rounded-lg shadow-md mb-4" role="alert">
                    <p class="font-bold">${type === 'success' ? 'Successo' : 'Attenzione'}</p>
                    <p>${message}</p>
                </div>
            `;
            
            const targetContainer = document.getElementById('message-container') || document.getElementById('app-content');
            targetContainer.insertAdjacentHTML('afterbegin', alertHtml);
            const alertElement = document.getElementById('temp-alert');
            
            setTimeout(() => {
                if (alertElement) {
                    alertElement.remove();
                }
            }, 5000);
        }
        
        // --- VISTA: AUTENTICAZIONE ---

        function renderAuthView() {
            const contentDiv = document.getElementById('app-content');
            
            let statusText = userId ? 
                `<p class="text-green-600 font-semibold">Stato: Autenticato (Dati sincronizzati su tutti i dispositivi)</p>` :
                `<p class="text-red-600 font-semibold">Stato: Disconnesso (Accedi o Registrati)</p>`;

            let actionButton = userId ? `
                <div class="mt-6 border-t pt-6 text-center">
                    <p class="text-gray-700">Sei connesso con l'account email.</p>
                    <button onclick="handleLogout()" class="mt-4 px-6 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition duration-150">
                        Logout
                    </button>
                </div>
            ` : `
                <div class="mt-6 border-t pt-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Registrazione</h3>
                    <p class="mb-4 text-gray-600 text-sm">Crea un nuovo account email per iniziare a sincronizzare i tuoi dati.</p>
                    <form id="register-form" onsubmit="event.preventDefault(); handleRegister(event);">
                        <input type="email" id="register-email" placeholder="Email" required class="w-full px-4 py-2 mb-3 border border-gray-300 rounded-lg">
                        <input type="password" id="register-password" placeholder="Password (min. 6 caratteri)" required class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-lg">
                        <button type="submit" class="w-full py-2 bg-yellow-500 text-gray-800 font-bold rounded-lg hover:bg-yellow-600 transition duration-150">
                            Registrati
                        </button>
                    </form>

                    <h3 class="text-xl font-bold text-gray-800 mb-4 mt-8 pt-4 border-t">Accesso</h3>
                    <form id="login-form" onsubmit="event.preventDefault(); handleLogin(event);">
                        <input type="email" id="login-email" placeholder="Email" required class="w-full px-4 py-2 mb-3 border border-gray-300 rounded-lg">
                        <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-2 mb-4 border border-gray-300 rounded-lg">
                        <button type="submit" class="w-full py-2 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition duration-150">
                            Accedi
                        </button>
                    </form>
                </div>
            `;


            contentDiv.innerHTML = `
                <div class="max-w-md mx-auto p-6 bg-white shadow-lg rounded-xl">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Gestione Account Cloud</h2>
                    <div class="text-center p-4 border border-gray-200 rounded-lg mb-6">
                        ${statusText}
                        <p class="text-xs text-gray-500 mt-1">ID Corrente: ${userId || 'N/A'}</p>
                    </div>

                    ${actionButton}

                    <div id="auth-message-container" class="mt-4"></div>
                </div>
            `;
        }

        // --- GESTIONE LOGICHE DI AUTENTICAZIONE ---

        async function handleRegister(event) {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            try {
                await firebaseApp.createUserWithEmailAndPassword(auth, email, password);
                
                alertAuthMessage("Registrazione e accesso eseguiti con successo! Dati pronti per la sincronizzazione.", 'success');
                showView('review'); 
            } catch (error) {
                console.error("Errore di registrazione:", error);
                if (error.code === 'auth/email-already-in-use') {
                    alertAuthMessage("Questa email √® gi√† in uso. Accedi invece.", 'danger');
                } else if (error.code === 'auth/weak-password') {
                    alertAuthMessage("Password troppo debole (minimo 6 caratteri).", 'danger');
                } else {
                    alertAuthMessage("Errore di registrazione. Riprova.", 'danger');
                }
            }
        }

        async function handleLogin(event) {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                await firebaseApp.signInWithEmailAndPassword(auth, email, password);

                alertAuthMessage("Accesso eseguito con successo! I tuoi dati cloud sono stati caricati.", 'success');
                showView('review'); // Sposta alla schermata di ripasso
            } catch (error) {
                console.error("Errore di login:", error);
                alertAuthMessage("Accesso fallito. Email o password errate.", 'danger');
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
                alertMessage("Logout effettuato. Per favore, accedi di nuovo per vedere i tuoi dati.", 'success');
            } catch (error) {
                console.error("Errore durante il logout:", error);
                alertMessage("Errore durante il logout.", 'danger');
            }
        }
        
        function alertAuthMessage(message, type) {
            const container = document.getElementById('auth-message-container');
            if (container) {
                alertMessage(message, type);
            }
        }


        // --- INIZIALIZZAZIONE GLOBALE E AUTENTICAZIONE ---

        async function initApp() {
            if (typeof window.firebaseApp === 'undefined') {
                setTimeout(initApp, 100);
                return;
            }

            db = firebaseApp.db;
            auth = firebaseApp.auth;
            
            const initialAuthToken = null; 

            // Listener per lo stato di autenticazione
            firebaseApp.onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    isAnonymous = user.isAnonymous || false; 
                    
                    const status = userId ? "Autenticato con Email" : "Non loggato";
                    document.getElementById('user-info').textContent = `Utente ID: ${userId} | Stato: Portabile (Cloud)`;
                    
                    await loadStats(); 
                    setupCardListener(); 
                } else {
                    userId = null;
                    isAuthReady = true;
                    isAnonymous = false;
                    document.getElementById('user-info').textContent = "Utente ID: NON LOGGATO";
                    currentView = 'auth';
                }
                
                showView(currentView);
            });
        }

        window.onload = initApp;

        /** Rende le funzioni globalmente accessibili per gli attributi onclick nell'HTML */
        window.showView = showView;
        window.showAnswer = showAnswer;
        window.handleReview = handleReview;
        window.handleCreateCard = handleCreateCard;
        window.previewMarkdown = previewMarkdown; 
        
        // Nuove funzioni di archivio
        window.editCard = editCard;
        window.handleSaveCard = handleSaveCard;
        window.handleDeleteCard = handleDeleteCard;

        // Funzioni di autenticazione esposte
        window.handleRegister = handleRegister; 
        window.handleLogin = handleLogin;
        window.handleLogout = handleLogout;
        window.alertAuthMessage = alertAuthMessage; 
    </script>
</body>
</html>
