<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRS Flashcard Cloud Sync</title>
    <!-- Caricamento di Tailwind CSS per uno styling rapido e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Caricamento di Marked.js per il rendering del Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Stili Personalizzati */
        :root {
            --primary-color: #3b82f6;
            --success-color: #10b981;
            --danger-color: #ef4444;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card-content {
            min-height: 150px;
            text-align: left;
            padding: 1.5rem;
            background: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        /* Stile per il contenuto Markdown */
        .card-content h1, .card-content h2 { font-size: 1.5em; margin-bottom: 0.5em; font-weight: 700; }
        .card-content p { margin-bottom: 1em; line-height: 1.6; }
        .card-content img { max-width: 100%; height: auto; border-radius: 0.5rem; margin: 1em 0; }
        .card-content ul { list-style: disc; margin-left: 1.5em; padding-left: 0; }
        .card-content strong { font-weight: 600; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Contenitore Principale -->
    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">SRS Cloud Flashcard Manager</h1>
        
        <!-- User ID Display (Importante per il Debug Firestore) -->
        <p id="user-info" class="text-xs text-center text-gray-500 mb-4">Utente: In attesa di autenticazione...</p>

        <!-- Navigazione (Menu) -->
        <nav class="flex justify-center space-x-4 mb-8">
            <button onclick="showView('review')" id="nav-review" class="px-4 py-2 text-sm font-medium rounded-lg transition duration-150 hover:bg-blue-100 bg-blue-500 text-white">Ripasso Giornaliero</button>
            <button onclick="showView('create')" id="nav-create" class="px-4 py-2 text-sm font-medium rounded-lg transition duration-150 hover:bg-gray-200 text-gray-700">Crea Nuova Carta</button>
            <button onclick="showView('stats')" id="nav-stats" class="px-4 py-2 text-sm font-medium rounded-lg transition duration-150 hover:bg-gray-200 text-gray-700">Riepilogo & Statistiche</button>
        </nav>

        <!-- Area Contenuto Dinamico -->
        <div id="app-content">
        </div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Attiva il logging per facilitare il debug
        setLogLevel('Debug');
        
	    // Import the functions you need from the SDKs you need
	    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
	    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
	    // TODO: Add SDKs for Firebase products that you want to use
	    // https://firebase.google.com/docs/web/setup#available-libraries
	    
	    // Your web app's Firebase configuration
	    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
	    const firebaseConfig = {
		  apiKey: "AIzaSyDN072WovJqyKE2Sw16PeSz1z9-50G8f9c",
		  authDomain: "flashcard-9d034.firebaseapp.com",
		  projectId: "flashcard-9d034",
		  storageBucket: "flashcard-9d034.firebasestorage.app",
		  messagingSenderId: "779697153912",
		  appId: "1:779697153912:web:163d564cd9dba40d338a8d",
		  measurementId: "G-6LWH9W8YEL"
	    };

	    // Initialize Firebase
	    const app = initializeApp(firebaseConfig);
	    const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.firebaseApp = { db, auth, onSnapshot }; // Esponi per l'uso nello script principale
    </script>

    <!-- Script JavaScript Principale -->
    <script>
        // CONFIGURAZIONE GLOBALE E MODELLO DATI
        const STORE_NAME = 'flashcards';
        const STATS_DOC_ID = 'global_stats';
        
        // A. Dati Globali (Constants)
        const INTERVALS = [1, 3, 7, 16, 35];

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        let allCards = [];
        let dueCards = [];
        let currentCardIndex = 0;
        let currentView = 'review';
        let stats = { totalOk: 0, totalKo: 0, totalCards: 0, topicStats: {} };

        // --- UTILITY PER DATE E LOGICA SRS ---

        function getMidnightTimestamp(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            return d.getTime();
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function calculateNextReview(card, isCorrect) {
            let newLevel = card.livelloDiRipetizione;

            if (isCorrect) {
                newLevel = Math.min(newLevel + 1, INTERVALS.length);
            } else {
                newLevel = Math.max(1, newLevel - 1);
            }

            const daysToWait = INTERVALS[newLevel - 1];
            const today = new Date();
            const nextReviewDate = getMidnightTimestamp(addDays(today, daysToWait));

            return {
                livelloDiRipetizione: newLevel,
                dataDiProssimoRipasso: nextReviewDate
            };
        }

        // --- LOGICA FIREBASE FIRESTORE ---

        /** Funzione per ottenere il riferimento alla collezione flashcards dell'utente corrente */
        function getCardsCollectionRef(database, currentUserId) {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return collection(database, 'artifacts', appId, 'users', currentUserId, STORE_NAME);
        }

        /** Funzione per ottenere il riferimento al documento delle statistiche dell'utente corrente */
        function getStatsDocRef(database, currentUserId) {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return doc(database, 'artifacts', appId, 'users', currentUserId, 'stats', STATS_DOC_ID);
        }
        
        /** Salva o aggiorna una singola carta nel cloud */
        async function saveCard(card) {
            if (!userId) {
                console.error("Tentativo di salvare la carta senza userId. Dati non salvati.");
                return;
            }
            try {
                // setDoc crea o sovrascrive il documento con l'ID specificato (card.id)
                await setDoc(doc(getCardsCollectionRef(db, userId), String(card.id)), card);
            } catch (error) {
                console.error("Errore nel salvataggio della carta in Firestore:", error);
                throw error;
            }
        }

        /** Salva le statistiche globali dell'utente */
        async function saveStats() {
            if (!userId) return;
            try {
                // setDoc con { merge: true } aggiorna solo i campi modificati
                await setDoc(getStatsDocRef(db, userId), stats, { merge: true });
            } catch (error) {
                console.error("Errore nel salvataggio delle statistiche in Firestore:", error);
                throw error;
            }
        }
        
        /** Carica le statistiche (una tantum, per inizializzazione) */
        async function loadStats() {
            if (!userId) return;
            try {
                const docSnap = await firebaseApp.getDoc(getStatsDocRef(db, userId));
                if (docSnap.exists()) {
                    stats = { ...stats, ...docSnap.data() };
                }
                stats.totalCards = allCards.length;
            } catch (error) {
                console.warn("Impossibile caricare le statistiche in Firestore.");
            }
        }

        /** Abilita l'ascolto in tempo reale dei dati delle flashcard */
        function setupCardListener() {
            if (!userId || !isAuthReady) return;

            const cardsQuery = query(getCardsCollectionRef(db, userId));

            // onSnapshot gestisce la prima lettura e gli aggiornamenti successivi
            const unsubscribe = firebaseApp.onSnapshot(cardsQuery, (snapshot) => {
                allCards = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Assicurati che dataDiProssimoRipasso sia un numero (timestamp)
                    data.dataDiProssimoRipasso = data.dataDiProssimoRipasso || 0; 
                    allCards.push(data);
                });

                const today = getMidnightTimestamp(new Date());

                dueCards = allCards
                    .filter(card => card.dataDiProssimoRipasso <= today)
                    .sort((a, b) => a.dataDiProssimoRipasso - b.dataDiProssimoRipasso);

                stats.totalCards = allCards.length;

                // Forza il re-rendering della vista corrente con i nuovi dati
                if (currentView === 'review' || currentView === 'stats') {
                    showView(currentView);
                }
                console.log(`[Firestore] Carte caricate/aggiornate: ${allCards.length}, Dovute oggi: ${dueCards.length}`);

            }, (error) => {
                console.error("Errore onSnapshot:", error);
                alertMessage("Errore di sincronizzazione dati: controllare la console.", 'danger');
            });

            return unsubscribe; 
        }

        // --- GESTIONE VISTE E FLUSSO APPLICAZIONE ---

        /** Gestisce il cambio di vista */
        function showView(viewName) {
            currentView = viewName;
            const contentDiv = document.getElementById('app-content');
            
            document.querySelectorAll('nav button').forEach(btn => {
                if (btn.id === `nav-${viewName}`) {
                    btn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    btn.classList.add('bg-blue-500', 'text-white', 'hover:bg-blue-600');
                } else {
                    btn.classList.remove('bg-blue-500', 'text-white', 'hover:bg-blue-600');
                    btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                }
            });

            if (!isAuthReady) {
                contentDiv.innerHTML = '<div class="text-center p-8 text-gray-600">Autenticazione in corso...</div>';
                return;
            }

            contentDiv.innerHTML = '<div class="flex justify-center items-center h-48"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div></div>';

            switch (viewName) {
                case 'review':
                    renderReviewView();
                    break;
                case 'create':
                    renderCreateView();
                    break;
                case 'stats':
                    loadStats().then(renderStatsView);
                    break;
                default:
                    renderReviewView();
            }
        }

        // --- 4. INTERFACCIA UTENTE (UI) ---

        // A. Schermata di Ripasso Giornaliero
        let isAnswerVisible = false;

        function renderReviewView() {
            const contentDiv = document.getElementById('app-content');
            
            if (dueCards.length === 0) {
                contentDiv.innerHTML = `
                    <div class="text-center p-8 bg-green-50 rounded-lg border border-green-200">
                        <svg class="mx-auto h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h2 class="text-xl font-semibold text-green-800 mt-3">Complimenti!</h2>
                        <p class="text-green-700 mt-1">Non hai carte da ripassare per oggi. Torna domani!</p>
                        <p class="text-sm text-green-600 mt-4">Totale carte in archivio: ${allCards.length}</p>
                    </div>
                `;
                return;
            }

            const card = dueCards[currentCardIndex];
            isAnswerVisible = false;

            const nextCardButtonHtml = (currentCardIndex < dueCards.length - 1) ? 
                `<p class="text-sm text-gray-500 mt-4">Prossima carta: ${currentCardIndex + 2} di ${dueCards.length}</p>` :
                `<p class="text-sm text-gray-500 mt-4">Questa √® l'ultima carta del giorno!</p>`;

            contentDiv.innerHTML = `
                <div class="text-center mb-6">
                    <p class="text-lg font-medium text-gray-600">Carta ${currentCardIndex + 1} di ${dueCards.length} in ripasso.</p>
                    <p class="text-sm text-gray-400">Argomento: <span class="font-semibold text-gray-600">${card.argomento}</span></p>
                </div>

                <!-- Contenitore della Carta -->
                <div class="bg-white rounded-xl shadow-lg border-2 border-blue-400 p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h2 class="text-2xl font-bold text-blue-700">Domanda:</h2>
                        <span class="px-3 py-1 bg-blue-100 text-blue-600 text-xs font-semibold rounded-full">Livello ${card.livelloDiRipetizione}</span>
                    </div>
                    
                    <!-- Contenuto Domanda (Markdown) -->
                    <div id="card-question-content" class="card-content">
                        ${marked.parse(card.domanda)}
                    </div>
                    
                    <button id="show-answer-btn" onclick="showAnswer()" class="w-full mt-6 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition duration-150">
                        Mostra Risposta
                    </button>
                    
                    <!-- Contenuto Risposta (Nascosto inizialmente) -->
                    <div id="card-answer-container" class="mt-6 border-t pt-6 hidden">
                        <h2 class="text-2xl font-bold text-green-700 mb-4">Risposta:</h2>
                        <div id="card-answer-content" class="card-content border-green-200">
                        </div>

                        <!-- Pulsanti Valutazione -->
                        <div class="flex justify-center space-x-4 mt-8">
                            <button onclick="handleReview(false)" class="flex items-center px-6 py-3 bg-red-500 text-white font-bold rounded-xl shadow-lg hover:bg-red-600 transition duration-150 transform hover:scale-105">
                                <span class="text-xl mr-2">‚ùå</span> KO (Sbagliata)
                            </button>
                            <button onclick="handleReview(true)" class="flex items-center px-6 py-3 bg-green-500 text-white font-bold rounded-xl shadow-lg hover:bg-green-600 transition duration-150 transform hover:scale-105">
                                <span class="text-xl mr-2">üëç</span> OK (Corretta)
                            </button>
                        </div>
                    </div>
                </div>
                ${nextCardButtonHtml}
            `;
        }


        /** Mostra la risposta e i pulsanti di valutazione */
        function showAnswer() {
            if (isAnswerVisible) return;
            isAnswerVisible = true;
            const card = dueCards[currentCardIndex];
            
            document.getElementById('show-answer-btn').classList.add('hidden');
            document.getElementById('card-answer-container').classList.remove('hidden');
            document.getElementById('card-answer-content').innerHTML = marked.parse(card.risposta);
        }

        /** Gestisce la valutazione (OK/KO) e aggiorna la carta nel DB */
        async function handleReview(isCorrect) {
            const card = dueCards[currentCardIndex];
            
            const srsResult = calculateNextReview(card, isCorrect);
            
            card.livelloDiRipetizione = srsResult.livelloDiRipetizione;
            card.dataDiProssimoRipasso = srsResult.dataDiProssimoRipasso;

            // Aggiorna le statistiche in memoria
            if (isCorrect) {
                stats.totalOk++;
            } else {
                stats.totalKo++;
            }
            if (!stats.topicStats[card.argomento]) {
                stats.topicStats[card.argomento] = { ok: 0, ko: 0 };
            }
            if (isCorrect) {
                stats.topicStats[card.argomento].ok++;
            } else {
                stats.topicStats[card.argomento].ko++;
            }

            try {
                // Salva le modifiche in Firestore
                await saveCard(card);
                await saveStats();
                
                // onSnapshot aggiorner√† automaticamente la UI. Qui passiamo semplicemente alla prossima carta
                currentCardIndex++;
                if (currentCardIndex < dueCards.length) {
                    renderReviewView();
                } else {
                    currentCardIndex = 0;
                    showView('review'); // Ricarica la vista (mostrer√† il messaggio "Complimenti")
                }

            } catch (e) {
                console.error("Errore nel salvataggio della carta:", e);
                alertMessage("Errore critico: impossibile salvare l'aggiornamento della carta nel cloud.", 'danger', 'message-container-review');
            }
        }

        // B. Schermata di Creazione Carte
        function renderCreateView() {
            const contentDiv = document.getElementById('app-content');
            
            contentDiv.innerHTML = `
                <div class="max-w-xl mx-auto p-6 bg-gray-50 rounded-xl shadow-inner">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Nuova Flashcard</h2>
                    <form id="create-card-form" onsubmit="event.preventDefault(); handleCreateCard(event);">
                        
                        <div class="mb-4">
                            <label for="argomento" class="block text-sm font-medium text-gray-700 mb-1">Argomento (Categorizzazione)</label>
                            <input type="text" id="argomento" name="argomento" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <div class="mb-4">
                            <label for="domanda" class="block text-sm font-medium text-gray-700 mb-1">Domanda (Markdown supportato)</label>
                            <textarea id="domanda" name="domanda" rows="4" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            <button type="button" onclick="previewMarkdown('domanda', 'preview-domanda')" class="mt-1 text-xs text-blue-600 hover:text-blue-800">Anteprima Domanda</button>
                            <div id="preview-domanda" class="mt-2 p-3 bg-white border border-dashed border-gray-300 rounded-lg hidden card-content"></div>
                        </div>

                        <div class="mb-6">
                            <label for="risposta" class="block text-sm font-medium text-gray-700 mb-1">Risposta (Markdown supportato)</label>
                            <textarea id="risposta" name="risposta" rows="6" required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            <button type="button" onclick="previewMarkdown('risposta', 'preview-risposta')" class="mt-1 text-xs text-blue-600 hover:text-blue-800">Anteprima Risposta</button>
                            <div id="preview-risposta" class="mt-2 p-3 bg-white border border-dashed border-gray-300 rounded-lg hidden card-content"></div>
                        </div>
                        
                        <button type="submit" class="w-full py-3 bg-green-500 text-white font-bold rounded-xl shadow-lg hover:bg-green-600 transition duration-150">
                            Salva Nuova Carta
                        </button>

                        <div id="message-container" class="mt-4"></div>
                    </form>
                </div>
            `;
        }
        
        /** Visualizza l'anteprima del Markdown */
        function previewMarkdown(inputId, previewId) {
            const input = document.getElementById(inputId).value;
            const preview = document.getElementById(previewId);
            
            if (input.trim() === '') {
                preview.classList.add('hidden');
                return;
            }
            
            preview.innerHTML = marked.parse(input); 
            preview.classList.remove('hidden');
        }

        /** Gestisce l'invio del modulo di creazione carta */
        async function handleCreateCard(event) {
            const form = event.target;
            const data = new FormData(form);

            const today = new Date();
            const tomorrow = getMidnightTimestamp(addDays(today, INTERVALS[0])); 

            // 2. MODELLO DATI - Struttura dell'Oggetto Carta & Inizializzazione
            const newCard = {
                id: Date.now(),
                domanda: data.get('domanda').trim(),
                risposta: data.get('risposta').trim(),
                argomento: data.get('argomento').trim() || 'Generale',
                livelloDiRipetizione: 1,
                dataDiProssimoRipasso: tomorrow
            };

            try {
                await saveCard(newCard);
                form.reset();
                const previewDomanda = document.getElementById('preview-domanda');
                const previewRisposta = document.getElementById('preview-risposta');
                if (previewDomanda) previewDomanda.classList.add('hidden');
                if (previewRisposta) previewRisposta.classList.add('hidden');
                
                alertMessage("Carta creata con successo! Dati sincronizzati nel cloud.", 'success');
            } catch (e) {
                console.error("Errore nel salvataggio della carta:", e);
                alertMessage("Errore: impossibile salvare la carta nel database cloud.", 'danger');
            }
        }

        // C. Schermata di Riepilogo e Statistiche
        function renderStatsView() {
            const contentDiv = document.getElementById('app-content');
            const totalAttempts = stats.totalOk + stats.totalKo;
            const successRate = totalAttempts > 0 ? ((stats.totalOk / totalAttempts) * 100).toFixed(1) : '0.0';
            const dueToday = dueCards.length;
            
            let topicRows = '';
            for (const [topic, topicStats] of Object.entries(stats.topicStats)) {
                const topicAttempts = topicStats.ok + topicStats.ko;
                const topicRate = topicAttempts > 0 ? ((topicStats.ok / topicAttempts) * 100).toFixed(1) : '0.0';
                
                topicRows += `
                    <tr>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${topic}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${topicStats.ok}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${topicStats.ko}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-bold ${parseFloat(topicRate) > 70 ? 'text-green-600' : 'text-orange-600'}">${topicRate}%</td>
                    </tr>
                `;
            }

            contentDiv.innerHTML = `
                <div class="p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Riepilogo e Statistiche Globali</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <!-- Stat Box 1: Carte Totali -->
                        <div class="bg-blue-50 p-6 rounded-xl shadow-md border-b-4 border-blue-500 text-center">
                            <p class="text-5xl font-extrabold text-blue-700">${stats.totalCards}</p>
                            <p class="text-gray-600 mt-2">Totale Carte Archiviate</p>
                        </div>
                        
                        <!-- Stat Box 2: Carte Dovute Oggi -->
                        <div class="bg-red-50 p-6 rounded-xl shadow-md border-b-4 border-red-500 text-center">
                            <p class="text-5xl font-extrabold text-red-700">${dueToday}</p>
                            <p class="text-gray-600 mt-2">Carte da Ripassare Oggi</p>
                        </div>
                        
                        <!-- Stat Box 3: Percentuale di Successo -->
                        <div class="bg-green-50 p-6 rounded-xl shadow-md border-b-4 border-green-500 text-center">
                            <p class="text-5xl font-extrabold text-green-700">${successRate}%</p>
                            <p class="text-gray-600 mt-2">Percentuale di Successo (OK)</p>
                        </div>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-800 mb-4 mt-8">Metriche per Argomento</h3>
                    <div class="overflow-x-auto shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-300">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Argomento</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Totale OK</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Totale KO</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tasso di Successo</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 bg-white">
                                ${topicRows || '<tr><td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">Nessuna statistica disponibile per argomento.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                    
                    <p class="text-sm text-gray-500 mt-6 text-center">Ultimo aggiornamento: ${new Date().toLocaleDateString('it-IT')}</p>
                </div>
            `;
        }

        // --- MESSAGGISTICA UI (Sostituto di alert()) ---

        /** Mostra un messaggio di notifica (successo/errore) */
        function alertMessage(message, type) {
            const container = document.getElementById('message-container') || document.getElementById('app-content');
            let bgColor, borderColor, textColor;

            switch(type) {
                case 'success':
                    bgColor = 'bg-green-100';
                    borderColor = 'border-green-400';
                    textColor = 'text-green-700';
                    break;
                case 'danger':
                    bgColor = 'bg-red-100';
                    borderColor = 'border-red-400';
                    textColor = 'text-red-700';
                    break;
                default:
                    bgColor = 'bg-blue-100';
                    borderColor = 'border-blue-400';
                    textColor = 'text-blue-700';
            }

            const alertHtml = `
                <div id="temp-alert" class="${bgColor} ${borderColor} ${textColor} border-l-4 p-4 rounded-lg shadow-md mb-4" role="alert">
                    <p class="font-bold">${type === 'success' ? 'Successo' : 'Attenzione'}</p>
                    <p>${message}</p>
                </div>
            `;
            
            const targetContainer = document.getElementById('message-container') || document.getElementById('app-content');
            targetContainer.insertAdjacentHTML('afterbegin', alertHtml);
            const alertElement = document.getElementById('temp-alert');
            
            setTimeout(() => {
                if (alertElement) {
                    alertElement.remove();
                }
            }, 5000);
        }

        // --- INIZIALIZZAZIONE GLOBALE E AUTENTICAZIONE ---

        async function initApp() {
            if (typeof window.firebaseApp === 'undefined') {
                setTimeout(initApp, 100);
                return;
            }

            db = firebaseApp.db;
            auth = firebaseApp.auth;
            
            // Esporre le funzioni di Firestore necessarie per le utility
            firebaseApp.getDoc = doc => getDoc(doc);
            
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            try {
                if (initialAuthToken) {
                    await firebaseApp.auth.signInWithCustomToken(firebaseApp.auth, initialAuthToken);
                } else {
                    await firebaseApp.auth.signInAnonymously(firebaseApp.auth);
                }
            } catch (error) {
                console.error("Errore di autenticazione Firebase:", error);
                alertMessage("Errore di autenticazione. I dati non saranno salvati.", 'danger');
                return;
            }

            // Listener per lo stato di autenticazione
            firebaseApp.onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    // Mostra l'ID utente (necessario per debug)
                    document.getElementById('user-info').textContent = `Utente ID: ${userId} (Cloud Sync)`;
                    
                    await loadStats(); 
                    setupCardListener(); 
                } else {
                    userId = null;
                    isAuthReady = false;
                    document.getElementById('user-info').textContent = "Utente ID: NON AUTENTICATO";
                }
                
                if (isAuthReady && currentView) {
                    showView(currentView);
                }
            });
        }

        window.onload = initApp;

        /** Rende le funzioni globalmente accessibili per gli attributi onclick nell'HTML */
        window.showView = showView;
        window.showAnswer = showAnswer;
        window.handleReview = handleReview;
        window.handleCreateCard = handleCreateCard;
        window.previewMarkdown = previewMarkdown;
    </script>
</body>
</html>
